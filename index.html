<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ID Photo Booth</title>
<style>
  body{margin:0;font-family:sans-serif;background:#f3f4f6;}
  h2{text-align:center;margin:12px 0;}
  .wrap{display:flex;justify-content:center;gap:30px;padding:20px;flex-wrap:wrap;}

  /* Left column */
  .camera-col{width:340px;display:flex;flex-direction:column;gap:10px;align-items:center}
  video{width:100%;aspect-ratio:7/9;background:#000;border-radius:8px;object-fit:cover}
  select,input,button{width:100%;padding:8px;font-size:16px;border-radius:6px}
  button{cursor:pointer;border:none;transition:0.2s}
  button:hover{opacity:0.85}
  #snap{background:#2563eb;color:#fff}
  #download{background:#16a34a;color:#fff;margin-top:8px;display:none}
  #flipCam{background:#6b7280;color:#fff}

  /* Card (right) */
  .card{
    width:350px;
    height:450px;
    position:relative;
    overflow:hidden;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    background:#000;
  }
  #shot{
    position:absolute;
    top:0;left:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:none;
  }
  .label{
    position:absolute;
    bottom:12px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.85);
    padding:4px 10px;
    border-radius:4px;
    font-size:18px;
    font-weight:bold;
  }
  .card::before {
    content:'';
    position:absolute;
    inset:0;
    border:4px solid #fff;
    border-radius:12px;
    pointer-events:none;
  }
</style>
</head>
<body>

<h2>Take Photo for ID</h2>

<div class="wrap">
  <!-- LEFT -->
  <div class="camera-col">
    <select id="cameraSelect"></select>
    <button id="flipCam">Flip Camera</button>
    <video id="video" autoplay playsinline muted></video>
    <input id="sid" placeholder="Enter ID">
    <button id="snap">Take Photo</button>
  </div>

  <!-- RIGHT -->
  <div>
    <div class="card" id="card">
      <img id="shot" alt="photo">
      <div id="label" class="label"></div>
    </div>
    <button id="download">Download</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const video=document.getElementById('video');
const sid=document.getElementById('sid');
const shot=document.getElementById('shot');
const label=document.getElementById('label');
const snap=document.getElementById('snap');
const card=document.getElementById('card');
const dl=document.getElementById('download');
const cameraSelect=document.getElementById('cameraSelect');
const flipCam=document.getElementById('flipCam');
let currentStream;
let usingFront=true;

// list available cameras
async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  cameraSelect.innerHTML = '';
  let count = 1;
  devices.forEach(device => {
    if (device.kind === 'videoinput') {
      const option = document.createElement('option');
      option.value = device.deviceId;
      const label = device.label.toLowerCase();
      if (label.includes('front')) option.text = 'ðŸ“± Front Camera';
      else if (label.includes('back')) option.text = 'ðŸ“· Back Camera';
      else option.text = `Camera ${count++}`;
      cameraSelect.appendChild(option);
    }
  });
  cameraSelect.style.display = cameraSelect.options.length > 1 ? 'block' : 'none';
}

// start camera by deviceId or facingMode
async function startCamera(deviceId) {
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());

  const constraints = deviceId
    ? { video: { deviceId: { exact: deviceId } } }
    : { video: { facingMode: usingFront ? 'user' : 'environment' } };

  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    video.srcObject = stream;
  } catch (err) {
    console.error('Error accessing camera:', err);
    alert('Unable to access camera. Please check permissions.');
  }
}

// when dropdown changes
cameraSelect.onchange = () => startCamera(cameraSelect.value);

// flip between front/back cameras
flipCam.onclick = async () => {
  usingFront = !usingFront;
  await startCamera();
};

// init on load
(async()=>{
  await listCameras();
  if (cameraSelect.options.length > 0) {
    await startCamera(cameraSelect.value);
  } else {
    await startCamera(); // fallback for mobile (facingMode)
  }
})();

// update ID label live
sid.addEventListener('input',()=>label.textContent='ID: '+sid.value);

// take photo (passport ratio 7:9)
snap.onclick=()=>{
  // flash effect
  document.body.style.transition='background 0.2s';
  document.body.style.background='#fff';
  setTimeout(()=>document.body.style.background='#f3f4f6',150);

  const vw = video.videoWidth;
  const vh = video.videoHeight;
  const aspect = 7/9;
  let cropW = vw;
  let cropH = vw / aspect;
  if (cropH > vh) {
    cropH = vh;
    cropW = vh * aspect;
  }
  const sx = (vw - cropW) / 2;
  const sy = (vh - cropH) / 2;

  const canvas = document.createElement('canvas');
  canvas.width = 350;
  canvas.height = 450;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, sx, sy, cropW, cropH, 0, 0, canvas.width, canvas.height);

  shot.src = canvas.toDataURL('image/png');
  shot.style.display = 'block';
  dl.style.display = 'block';
};

// download card as image
dl.onclick=()=>{
  html2canvas(card,{
    backgroundColor:null,
    scale:3,
    useCORS:true
  }).then(cv=>{
    const a=document.createElement('a');
    a.download=(sid.value || 'id-card')+'.png';
    a.href=cv.toDataURL('image/png');
    a.click();
  });
};
</script>
</body>
</html>
